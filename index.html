<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Appunti-AI Professionale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style id="maincss">
    html { min-height:100%; }
    body {
      font-family: var(--font, Arial), sans-serif;
      background: var(--bg, #fafafa);
      color: var(--fg, #222);
      max-width: 700px;
      margin: 2rem auto;
      padding:0 2vw;
      transition: background 0.2s, color 0.2s;
      font-size: var(--fontsize, 1em);
    }
    .compact .section { margin-top: 10px; margin-bottom: 10px;}
    h1 {
      font-size: 2.2em;
      margin-top: 36px;
      margin-bottom: 36px;
      line-height: 1.13;
      font-weight: bold;
      letter-spacing: -0.5px;
    }
    .section {margin: 26px 0 20px 0;}
    .label {
      color: #374151;
      font-weight: bold;
      font-size: 15px;
      margin-top: 16px;
      margin-bottom: 7px;
      display: block;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 11px 13px;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      margin-top: 4px;
      margin-bottom: 0.5em;
      background: var(--input-bg, #fff);
      color: var(--input-fg, inherit);
      transition: box-shadow 0.2s, border 0.2s, background 0.2s, color 0.2s;
      box-sizing: border-box;
    }
    input[type="text"]:focus, textarea:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 2px #a5b4fc88;
      border-color: #6366f1;
    }
    input[type="file"] {margin-bottom: 0.7em;}
    .actions {
      margin: 32px 0;
      display: flex;
      gap: 1em;
      flex-wrap: wrap;
    }
    button, .file-remove-btn {
      padding: 10px 22px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      background: #6366f1;
      color: #fff;
      box-shadow: 0 2px 12px 0 #6366f120;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s;
      font-size: 1em;
      margin-right: 6px;
    }
    button:hover, .file-remove-btn:hover {
      background: #4f46e5;
      box-shadow: 0 3px 14px 0 #6366f149;
    }
    .file-list {margin: 0.5em 0 0.8em 0; padding-left: 0; list-style: none;}
    .file-item { display: flex; align-items: center; background: #f4f4fd; border-radius: 6px; padding: 7px 8px; margin-bottom: 6px; font-size: 14px;}
    .file-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .footer { font-size: 12px; color: #888; text-align: right; margin-top: 2em; }
    hr { margin: 2em 0; }
    .toast {
      position: fixed; bottom: 32px; left: 50%;
      transform: translateX(-50%);
      min-width: 160px;
      background: #3730a3;
      color: #fff; padding: 13px 30px;
      border-radius: 8px; font-size: 1em;
      box-shadow: 0 2px 14px 0 #6366f145;
      opacity: 0;
      transition: opacity 0.3s; z-index: 9999;
      pointer-events: none;
    }
    .toast.active { opacity: 1; pointer-events: auto; }
    .spinner-overlay {position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;}
    .lds-dual-ring {display: inline-block; width: 64px; height: 64px;}
    .lds-dual-ring:after {content: " "; display: block; width: 46px; height: 46px; margin: 8px; border-radius: 50%; border: 6px solid #6366f1; border-color: #6366f1 transparent #6366f1 transparent; animation: lds-dual-ring 1.1s linear infinite;}
    @keyframes lds-dual-ring {0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);}}
    /* Tema scuro dinamico */
    body.dark {
      --bg: #171923;
      --fg: #fafafa;
      --input-bg: #23263b;
      --input-fg: #fff;
    }
    body.dark .section { border-color: #343449;}
    body.dark .file-item { background: #22223c;}
    body.dark .footer,
    body.dark .file-info { color: #bbbbbb;}
    /* Personalizzazione preview */
    .custom-controls {
      display: flex; gap: 1em; align-items: center; margin-bottom:16px; flex-wrap:wrap;
    }
    .custom-controls label {font-size: 0.95em; color:#444;}
    .version-list {
      margin:1em 0; padding:0;
      border:1px solid #dadada; border-radius:7px; background:#fafafb;
      list-style:none;
      max-height:180px; overflow-y:auto; font-size:13px;
    }
    .version-list li { border-bottom:1px solid #eee; padding:7px 14px; display:flex; justify-content:space-between;}
    .version-list li:last-child {border-bottom:none;}
    .version-btn {background:#2780e3;}
    .version-btn:hover {background:#0560ba;}
    @media (max-width: 600px) {
      body {max-width: 100vw; margin: 0.5rem;}
      h1 {font-size: 1.3em; margin-top: 26px; margin-bottom: 18px;}
      .section { margin: 14px 0 12px 0;}
      .actions { flex-direction: column; gap: 0.7em;}
      button {width: 100%; padding: 11px;}
      .custom-controls {flex-direction:column; align-items:flex-start;}
    }
  </style>
</head>
<body>
  <div class="custom-controls">
    <button id="themeToggle" title="Tema Chiaro/Scuro">üåì Tema</button>
    <label>Font
      <select id="fontChoice">
        <option value="Arial">Arial</option>
        <option value="Inter" selected>Inter</option>
        <option value="Roboto">Roboto</option>
        <option value="Georgia">Georgia</option>
        <option value="monospace">Monospace</option>
      </select>
    </label>
    <label>Testo
      <select id="fontSizeChoice">
        <option value="1em">Normale</option>
        <option value="1.18em">Grande</option>
        <option value="0.90em">Compatto</option>
      </select>
    </label>
    <label><input type="checkbox" id="compactToggle"> Compatta spazi</label>
  </div>
  <h1>Appunti-AI Professionale</h1>
  <div class="section">
    <span class="label">Titolo documento</span>
    <input type="text" id="docTitle" value="">
  </div>
  <div class="section">
    <span class="label">Data</span>
    <input type="text" id="docDate" value="">
  </div>
  <div class="section">
    <span class="label">File di riferimento</span>
    <input type="text" id="docRef" value="">
  </div>
  <div class="section">
    <span class="label">Appunti / Corpo</span>
    <input id="fileInput" type="file" multiple accept=".txt,.pdf,.doc,.docx,.md,.mp3,.wav,.m4a" />
    <ul id="fileList" class="file-list"></ul>
    <textarea id="notes" rows="8" placeholder="Qui inserisci o carica gli appunti..."></textarea>
  </div>
  <div class="section">
    <span class="label">Note aggiuntive</span>
    <textarea id="extra" rows="3" placeholder="Note extra, dettagli, firma..."></textarea>
  </div>
  <div class="actions">
    <button id="pdfBtn">Esporta PDF</button>
    <button id="copyBtn">Copia testo</button>
    <button id="clearBtn">Pulisci tutto</button>
    <button id="backupBtn">Esporta Backup</button>
    <button id="importBtn">Importa Backup</button>
    <input id="importBackup" type="file" style="display:none;" accept="application/json">
  </div>
  <div class="section" style="margin-top:24px;">
    <b>Cronologia Backup versioni</b>
    <ul id="versionList" class="version-list"></ul>
  </div>
  <hr>
  <div class="footer">¬© Appunti-AI ¬∑ www.appunti-ai.com</div>
  <div id="spinner" class="spinner-overlay" style="display:none;">
    <div class="lds-dual-ring"></div>
  </div>
  <div id="toast" class="toast"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  // THEMES & PREFERENCES--------------------------
  function applyTheme(theme) {
    document.body.classList.toggle("dark", theme === "dark");
    localStorage.setItem("aai_theme", theme);
  }
  function getInitialTheme() {
    const t = localStorage.getItem("aai_theme");
    if (t) return t;
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  }
  document.addEventListener("DOMContentLoaded", () => {
    applyTheme(getInitialTheme());
    document.getElementById("themeToggle").onclick = () => {
      const newTheme = document.body.classList.contains("dark") ? "light" : "dark";
      applyTheme(newTheme);
    };
    // Personalizzazione font/dimensione
    const fontChoice = document.getElementById("fontChoice");
    const fontSizeChoice = document.getElementById("fontSizeChoice");
    const compactToggle = document.getElementById("compactToggle");
    function applyCustom() {
      document.body.style.setProperty('--font', fontChoice.value);
      document.body.style.setProperty('--fontsize', fontSizeChoice.value);
      document.body.classList.toggle("compact", compactToggle.checked);
      localStorage.setItem("aai_font", fontChoice.value);
      localStorage.setItem("aai_fontsize", fontSizeChoice.value);
      localStorage.setItem("aai_compact", compactToggle.checked?"1":"");
    }
    fontChoice.value = localStorage.getItem("aai_font") || "Inter";
    fontSizeChoice.value = localStorage.getItem("aai_fontsize") || "1em";
    compactToggle.checked = !!localStorage.getItem("aai_compact");
    fontChoice.onchange = applyCustom;
    fontSizeChoice.onchange = applyCustom;
    compactToggle.onchange = applyCustom;
    applyCustom();
  });
  // UTILITY =============
  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 1800);
  }
  function showSpinner() { document.getElementById("spinner").style.display = "flex"; }
  function hideSpinner() { document.getElementById("spinner").style.display = "none"; }
  // BACKUP VERSIONING =============
  function saveVersion(){
    let versions = JSON.parse(localStorage.getItem("aai_versions")||"[]");
    const data = {
      ts: new Date().toLocaleString(),
      data: localStorage.getItem('appuntiAI')
    };
    versions.unshift(data);
    if (versions.length>10) versions = versions.slice(0,10);
    localStorage.setItem("aai_versions", JSON.stringify(versions));
    renderVersions();
  }
  function renderVersions(){
    const list = document.getElementById("versionList");
    const versions = JSON.parse(localStorage.getItem("aai_versions")||"[]");
    list.innerHTML = versions.length ? "" : "<li>Nessun backup ancora.</li>";
    versions.forEach((v,i) => {
      const li = document.createElement("li");
      li.innerHTML = `<span>${v.ts}</span>
      <button class="version-btn" onclick="restoreVersion(${i})">Ripristina</button>`;
      list.appendChild(li);
    });
  }
  window.restoreVersion = function(idx){
    const versions = JSON.parse(localStorage.getItem("aai_versions")||"[]");
    if (versions[idx]?.data) {
      localStorage.setItem("appuntiAI", versions[idx].data);
      loadLocal();
      showToast("Versione ripristinata!");
    }
  };
  // ----- SALVATAGGIO E CARICAMENTO AUTOMATICO -----
  let filesState = [];
  function saveLocal() {
    const files = filesState.map(f => ({
      name: f.name, size: f.size, type: f.type, lastModified: f.lastModified, data: f.data || null
    }));
    localStorage.setItem('appuntiAI', JSON.stringify({
      docTitle: document.getElementById("docTitle").value,
      docDate: document.getElementById("docDate").value,
      docRef: document.getElementById("docRef").value,
      notes: document.getElementById("notes").value,
      extra: document.getElementById("extra").value,
      files
    }));
    saveVersion();
  }
  function loadLocal() {
    const data = JSON.parse(localStorage.getItem('appuntiAI') || "{}");
    if (data.docTitle !== undefined) document.getElementById("docTitle").value = data.docTitle;
    if (data.docDate !== undefined) document.getElementById("docDate").value = data.docDate;
    if (data.docRef !== undefined) document.getElementById("docRef").value = data.docRef;
    if (data.notes !== undefined) document.getElementById("notes").value = data.notes;
    if (data.extra !== undefined) document.getElementById("extra").value = data.extra;
    if (data.files) {
      filesState = data.files;
      renderFileList();
    }
    renderVersions();
  }
  // ---- FILE STATE E RENDER ----
  const fileListEl = document.getElementById("fileList");
  function renderFileList() {
    fileListEl.innerHTML = "";
    filesState.forEach((file, idx) => {
      const li = document.createElement("li");
      li.className = "file-item";
      const exts = file.name.split(".").pop().toUpperCase();
      const typeIcon = file.type.startsWith("audio/") ? "üé§"
                    : file.type === "application/pdf" ? "üìÑ"
                    : exts === "DOCX" ? "üìù"
                    : "üìÑ";
      li.innerHTML = `<span class="file-name">${typeIcon} ${file.name} <span style="color:#aaa;">(${(file.size/1024).toFixed(1)} KB)</span></span>
          <button class="file-remove-btn" title="Rimuovi" onclick="removeFile(${idx}); event.stopPropagation();">üóëÔ∏è</button>
          <button class="file-remove-btn" title="Estrai testo" onclick="extractText(${idx}); event.stopPropagation();" style="background:#22c55e;">‚¨áÔ∏è</button>`;
      fileListEl.appendChild(li);
    });
    saveLocal();
  }
  function removeFile(index) {
    filesState.splice(index,1);
    renderFileList();
    showToast("File rimosso");
  }
  // ---- CARICAMENTO FILE ----
  document.getElementById("fileInput").addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    let added = 0;
    for (const file of files) {
      let data = null;
      if (file.size < 2*1024*1024) {
        data = await new Promise(res => {
          const r = new FileReader();
          r.onload = e => res(e.target.result);
          r.readAsDataURL(file);
        });
      }
      filesState.push({ name: file.name, size: file.size, type: file.type, lastModified: file.lastModified, data });
      added++;
    }
    renderFileList();
    e.target.value = "";
    if (added) showToast(`${added} file aggiunto${added>1?'i':''}`);
  });
  // ---- ESTRAZIONE TESTO FILE ----
  window.extractText = function(idx) {
    const file = filesState[idx];
    showSpinner();
    if (file.type.startsWith("audio/")) {
      trascriviAudioOpenAI(file);
      return;
    }
    if (file.type === "application/pdf") {
      estraiTestoPDF(file);
      return;
    }
    if (file.name.endsWith(".docx")) {
      estraiTestoDOCX(file);
      return;
    }
    leggiTesto(file);
  };
  function b64toBlob(dataURI, mime) {
    var byteString = atob(dataURI.split(',')[1]);
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++) {
      ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], {type: mime});
  }
  function leggiTesto(file) {
    if (file.data) {
      const blob = b64toBlob(file.data, file.type || 'text/plain');
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById("notes").value = e.target.result;
        hideSpinner();
        saveLocal();
        showToast("Testo caricato");
      };
      reader.readAsText(blob,"UTF-8");
    } else {
      showToast("Ricarica il file originale o usa file pi√π piccoli");
      hideSpinner();
    }
  }
  function estraiTestoPDF(file) {
    if (file.data) {
      const blob = b64toBlob(file.data, file.type);
      const reader = new FileReader();
      reader.onload = function(e) {
        const typedarray = new Uint8Array(e.target.result);
        pdfjsLib.getDocument(typedarray).promise.then(pdf => {
          let testoTotale = "";
          let promesse = [];
          for (let i = 1; i <= pdf.numPages; i++) {
            promesse.push(pdf.getPage(i).then(page =>
              page.getTextContent().then(txt => {
                testoTotale += txt.items.map(item => item.str).join(" ") + "\n";
              })
            ));
          }
          Promise.all(promesse).then(() => {
            document.getElementById("notes").value = testoTotale;
            hideSpinner();
            saveLocal();
            showToast("Testo PDF estratto");
          });
        }).catch(() => {
          alert("Errore estrazione PDF.");
          hideSpinner();
        });
      };
      reader.readAsArrayBuffer(blob);
    }
  }
  function estraiTestoDOCX(file) {
    if (file.data) {
      const blob = b64toBlob(file.data, file.type);
      const reader = new FileReader();
      reader.onload = function(e) {
        mammoth.convertToHtml({ arrayBuffer: e.target.result })
          .then(result => {
            const html = result.value;
            const txt = html.replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ').trim();
            document.getElementById("notes").value = txt;
            hideSpinner();
            saveLocal();
            showToast("Testo DOCX estratto");
          })
          .catch(() => {
            alert("Errore estrazione DOCX.");
            hideSpinner();
          });
      };
      reader.readAsArrayBuffer(blob);
    }
  }
  function trascriviAudioOpenAI(file) {
    fetch("/api/trascrivi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        audioBase64: file.data?.split(',')[1] || "",
        audioMimeType: file.type
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.testo) {
        document.getElementById("notes").value = data.testo;
        showToast("Trascrizione audio completata");
      } else {
        alert("Errore trascrizione audio.");
      }
      hideSpinner();
      saveLocal();
    })
    .catch(() => {
      alert("Errore nella richiesta di trascrizione audio.");
      hideSpinner();
    });
  }
  // ---- DATI ----
  ["docTitle","docDate","docRef","notes","extra"].forEach(id => {
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById(id).addEventListener("input", saveLocal);
    });
  });
  document.addEventListener("DOMContentLoaded", () => {
    if (!localStorage.getItem("appuntiAI")) {
      document.getElementById("docDate").value = new Date().toLocaleDateString();
    }
    loadLocal();
    if (!document.getElementById("docDate").value) {
      document.getElementById("docDate").value = new Date().toLocaleDateString();
    }
    renderVersions();
  });
  // ---- AZIONI ----
  document.getElementById("copyBtn").onclick = () => {
    const output = `${document.getElementById("docTitle").value}\n${document.getElementById("docDate").value}\n${document.getElementById("docRef").value}\n\n${document.getElementById("notes").value}\n\n${document.getElementById("extra").value}`;
    navigator.clipboard.writeText(output)
      .then(() => { showToast("Testo copiato negli appunti"); });
  };
  document.getElementById("clearBtn").onclick = () => {
    document.getElementById("docTitle").value = "";
    document.getElementById("docDate").value = new Date().toLocaleDateString();
    document.getElementById("docRef").value = "";
    document.getElementById("notes").value = "";
    document.getElementById("extra").value = "";
    filesState = [];
    renderFileList();
    localStorage.removeItem('appuntiAI');
    showToast("Dati resettati!");
  };
  document.getElementById("pdfBtn").onclick = () => {
    const titolo = document.getElementById("docTitle").value;
    const data = document.getElementById("docDate").value;
    const ref = document.getElementById("docRef").value;
    const corpo = document.getElementById("notes").value;
    const extra = document.getElementById("extra").value;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });

    doc.setFontSize(18);
    doc.text(titolo, 20, 22);
    doc.setFontSize(12);
    doc.text(`Data: ${data}`, 150, 22);
    doc.setDrawColor(180,180,180);
    doc.line(20, 26, 190, 26);

    doc.setFontSize(13);
    let y = 34;
    if (ref.trim()) {
      doc.text(`Documento di riferimento: ${ref}`, 20, y);
      y += 8;
    }
    doc.setFontSize(13);
    doc.text("Appunti:", 20, y); y += 7;
    const noteLines = doc.splitTextToSize(corpo, 160);
    noteLines.forEach(line => { doc.text(line, 20, y); y += 7; });
    if (extra.trim()) {
      y += 6;
      doc.setFontSize(12);
      doc.text("Note aggiuntive:", 20, y); y += 7;
      const extraLines = doc.splitTextToSize(extra, 160);
      extraLines.forEach(line => { doc.text(line, 20, y); y += 7; });
    }
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text(`¬© Appunti-AI ¬∑ www.appunti-ai.com ¬∑ ${new Date().getFullYear()}`, 20, 287);

    doc.save(`AppuntiAI-${new Date().toISOString().slice(0,10)}.pdf`);
    showToast("PDF generato!");
  };
  // ---- BACKUP/IMPORT ----
  document.getElementById("backupBtn").onclick = () => {
    const savedata = localStorage.getItem("appuntiAI") || "{}";
    const blob = new Blob([savedata], {type:"application/json"});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `AppuntiAI_backup_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast("Backup salvato");
  };
  document.getElementById("importBtn").onclick = () => {
    document.getElementById("importBackup").click();
  };
  document.getElementById("importBackup").onchange = function(ev) {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const obj = JSON.parse(e.target.result);
        localStorage.setItem("appuntiAI", JSON.stringify(obj));
        loadLocal();
        showToast("Backup importato!");
      } catch {
        alert("Il file di backup non √® valido!");
      }
    };
    reader.readAsText(file, "utf-8");
    this.value = "";
  };
</script>
</body>
</html>
