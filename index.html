<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Appunti-AI Professionale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 2rem auto; background: #fafafa; color: #2a2a2a; }
    h1 { font-size: 2.2em; margin-top: 36px; margin-bottom: 36px; }
    .section { margin: 26px 0 20px 0; }
    .label {
      color: #374151;
      font-weight: bold;
      font-size: 15px;
      margin-top: 16px;
      margin-bottom: 7px;
      display: block;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 11px 13px;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      margin-top: 4px;
      margin-bottom: 0.5em;
      background: #fff;
      transition: box-shadow 0.2s, border 0.2s;
      box-sizing: border-box;
    }
    input[type="text"]:focus, textarea:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 2px #a5b4fc88;
      border-color: #6366f1;
    }
    input[type="file"] {
      margin-bottom: 0.7em;
    }
    .actions {
      margin: 32px 0;
      display: flex;
      gap: 1em;
      flex-wrap: wrap;
    }
    button, .file-remove-btn {
      padding: 10px 22px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      background: #6366f1;
      color: #fff;
      box-shadow: 0 2px 12px 0 #6366f120;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s;
      font-size: 1em;
      margin-right: 6px;
    }
    button:hover, .file-remove-btn:hover {
      background: #4f46e5;
      box-shadow: 0 3px 14px 0 #6366f149;
    }
    .file-list {
      margin: 0.5em 0 0.8em 0;
      padding-left: 0;
      list-style: none;
    }
    .file-item {
      display: flex;
      align-items: center;
      background: #f4f4fd;
      border-radius: 6px;
      padding: 7px 8px;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .file-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .footer { font-size: 12px; color: #888; text-align: right; margin-top: 2em; }
    hr { margin: 2em 0; }
    .file-info { font-size: 12px; color: #666; margin-bottom: 0.3em; }
    .toast {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      min-width: 160px;
      background: #3730a3;
      color: #fff;
      padding: 13px 30px;
      border-radius: 8px;
      font-size: 1em;
      box-shadow: 0 2px 14px 0 #6366f145;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 9999;
      pointer-events: none;
    }
    .toast.active { opacity: 1; pointer-events: auto; }
    .spinner-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .lds-dual-ring {
      display: inline-block;
      width: 64px; height: 64px;
    }
    .lds-dual-ring:after {
      content: " ";
      display: block;
      width: 46px;
      height: 46px;
      margin: 8px;
      border-radius: 50%;
      border: 6px solid #6366f1;
      border-color: #6366f1 transparent #6366f1 transparent;
      animation: lds-dual-ring 1.1s linear infinite;
    }
    @keyframes lds-dual-ring {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    @media (max-width: 600px) {
      body { max-width: 100vw; margin: 0.5rem; }
      h1 { font-size: 1.3em; margin-top: 26px; margin-bottom: 18px; }
      .section { margin: 16px 0 14px 0; }
      .actions { flex-direction: column; gap: 0.7em; }
      button { width: 100%; padding: 11px; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div id="app-main">
    <h1>Appunti-AI Professionale</h1>
    <div class="section">
      <span class="label">Titolo documento</span>
      <input type="text" id="docTitle" value="">
    </div>
    <div class="section">
      <span class="label">Data</span>
      <input type="text" id="docDate" value="">
    </div>
    <div class="section">
      <span class="label">File di riferimento</span>
      <input type="text" id="docRef" value="">
    </div>
    <div class="section">
      <span class="label">Appunti / Corpo</span>
      <input id="fileInput" type="file" multiple accept=".txt,.pdf,.doc,.docx,.md,.mp3,.wav,.m4a" />
      <ul id="fileList" class="file-list"></ul>
      <textarea id="notes" rows="8" placeholder="Qui inserisci o carica gli appunti..."></textarea>
    </div>
    <div class="section">
      <span class="label">Note aggiuntive</span>
      <textarea id="extra" rows="3" placeholder="Note extra, dettagli, firma..."></textarea>
    </div>
    <div class="actions">
      <button id="pdfBtn">Esporta PDF</button>
      <button id="copyBtn">Copia testo</button>
      <button id="clearBtn">Pulisci tutto</button>
      <button id="backupBtn">Esporta Backup</button>
      <button id="importBtn">Importa Backup</button>
      <input id="importBackup" type="file" style="display:none;" accept="application/json">
    </div>
    <hr>
    <div class="footer">¬© Appunti-AI ¬∑ www.appunti-ai.com</div>
  </div>
  <div id="spinner" class="spinner-overlay" style="display:none;">
    <div class="lds-dual-ring"></div>
  </div>
  <div id="toast" class="toast"></div>
<script>
  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 1800);
  }
  function showSpinner() { document.getElementById("spinner").style.display = "flex"; }
  function hideSpinner() { document.getElementById("spinner").style.display = "none"; }

  // ----- SALVATAGGIO E CARICAMENTO AUTOMATICO -----
  function saveLocal() {
    // Serializza i file come array di oggetti solo info.
    const files = filesState.map(f => ({
      name: f.name, size: f.size, type: f.type, lastModified: f.lastModified, data: f.data || null
    }));
    localStorage.setItem('appuntiAI', JSON.stringify({
      docTitle: document.getElementById("docTitle").value,
      docDate: document.getElementById("docDate").value,
      docRef: document.getElementById("docRef").value,
      notes: document.getElementById("notes").value,
      extra: document.getElementById("extra").value,
      files
    }));
  }
  function loadLocal() {
    const data = JSON.parse(localStorage.getItem('appuntiAI') || "{}");
    if (data.docTitle !== undefined) document.getElementById("docTitle").value = data.docTitle;
    if (data.docDate !== undefined) document.getElementById("docDate").value = data.docDate;
    if (data.docRef !== undefined) document.getElementById("docRef").value = data.docRef;
    if (data.notes !== undefined) document.getElementById("notes").value = data.notes;
    if (data.extra !== undefined) document.getElementById("extra").value = data.extra;
    if (data.files) {
      filesState = data.files;
      renderFileList();
    }
  }

  // ---- FILE STATE E RENDER ----
  let filesState = [];
  const fileListEl = document.getElementById("fileList");

  function renderFileList() {
    fileListEl.innerHTML = "";
    filesState.forEach((file, idx) => {
      const li = document.createElement("li");
      li.className = "file-item";
      const exts = file.name.split(".").pop().toUpperCase();
      const typeIcon = file.type.startsWith("audio/") ? "üé§"
                    : file.type === "application/pdf" ? "üìÑ"
                    : exts === "DOCX" ? "üìù"
                    : "üìÑ";
      li.innerHTML = `<span class="file-name">${typeIcon} ${file.name} <span style="color:#aaa;">(${(file.size/1024).toFixed(1)} KB)</span></span>
          <button class="file-remove-btn" title="Rimuovi" onclick="removeFile(${idx}); event.stopPropagation();">üóëÔ∏è</button>
          <button class="file-remove-btn" title="Estrai testo" onclick="extractText(${idx}); event.stopPropagation();" style="background:#22c55e;">‚¨áÔ∏è</button>`;
      fileListEl.appendChild(li);
    });
    saveLocal();
  }

  function removeFile(index) {
    filesState.splice(index,1);
    renderFileList();
    showToast("File rimosso");
  }

  // ---- CARICAMENTO FILE ----
  document.getElementById("fileInput").addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    let added = 0;
    for (const file of files) {
      // Leggi base64 per persistenza semplice (piccoli file)
      let data = null;
      if (file.size < 2*1024*1024) { // Solo file piccoli
        data = await new Promise(res => {
          const r = new FileReader();
          r.onload = e => res(e.target.result);
          r.readAsDataURL(file);
        });
      }
      filesState.push({ name: file.name, size: file.size, type: file.type, lastModified: file.lastModified, data });
      added++;
    }
    renderFileList();
    e.target.value = "";
    if (added) showToast(`${added} file aggiunto${added>1?'i':''}`);
  });

  // ---- ESTRAZIONE TESTO FILE ----
  window.extractText = function(idx) {
    const file = filesState[idx];
    showSpinner();
    // Se file √® piccolo e salvato, lavoriamo direttamente su data base64. Altrimenti pop-up per caricarlo.
    // In ambiente reale, meglio una struttura bifase: qui per demo rapidit√†!
    if (file.type.startsWith("audio/")) {
      trascriviAudioOpenAI(file);
      return;
    }
    if (file.type === "application/pdf") {
      estraiTestoPDF(file);
      return;
    }
    if (file.name.endsWith(".docx")) {
      estraiTestoDOCX(file);
      return;
    }
    leggiTesto(file);
  };

  function b64toBlob(dataURI, mime) {
    var byteString = atob(dataURI.split(',')[1]);
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++) {
      ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], {type: mime});
  }
  function leggiTesto(file) {
    if (file.data) {
      // Da dataURL salvato
      const blob = b64toBlob(file.data, file.type || 'text/plain');
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById("notes").value = e.target.result;
        hideSpinner();
        saveLocal();
        showToast("Testo caricato");
      };
      reader.readAsText(blob,"UTF-8");
    } else {
      showToast("Ricarica il file originale o usa file pi√π piccoli");
      hideSpinner();
    }
  }
  function estraiTestoPDF(file) {
    if (file.data) {
      const blob = b64toBlob(file.data, file.type);
      const reader = new FileReader();
      reader.onload = function(e) {
        const typedarray = new Uint8Array(e.target.result);
        pdfjsLib.getDocument(typedarray).promise.then(pdf => {
          let testoTotale = "";
          let promesse = [];
          for (let i = 1; i <= pdf.numPages; i++) {
            promesse.push(pdf.getPage(i).then(page =>
              page.getTextContent().then(txt => {
                testoTotale += txt.items.map(item => item.str).join(" ") + "\n";
              })
            ));
          }
          Promise.all(promesse).then(() => {
            document.getElementById("notes").value = testoTotale;
            hideSpinner();
            saveLocal();
            showToast("Testo PDF estratto");
          });
        }).catch(() => {
          alert("Errore estrazione PDF.");
          hideSpinner();
        });
      };
      reader.readAsArrayBuffer(blob);
    }
  }
  function estraiTestoDOCX(file) {
    if (file.data) {
      const blob = b64toBlob(file.data, file.type);
      const reader = new FileReader();
      reader.onload = function(e) {
        mammoth.convertToHtml({ arrayBuffer: e.target.result })
          .then(result => {
            const html = result.value;
            const txt = html.replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ').trim();
            document.getElementById("notes").value = txt;
            hideSpinner();
            saveLocal();
            showToast("Testo DOCX estratto");
          })
          .catch(() => {
            alert("Errore estrazione DOCX.");
            hideSpinner();
          });
      };
      reader.readAsArrayBuffer(blob);
    }
  }
  function trascriviAudioOpenAI(file) {
    // Esempio rapido: dati base64 gi√† in file.data (audiodata)
    fetch("/api/trascrivi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        audioBase64: file.data?.split(',')[1] || "",
        audioMimeType: file.type
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.testo) {
        document.getElementById("notes").value = data.testo;
        showToast("Trascrizione audio completata");
      } else {
        alert("Errore trascrizione audio.");
      }
      hideSpinner();
      saveLocal();
    })
    .catch(() => {
      alert("Errore nella richiesta di trascrizione audio.");
      hideSpinner();
    });
  }

  // ---- DATI ----
  ["docTitle","docDate","docRef","notes","extra"].forEach(id => {
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById(id).addEventListener("input", saveLocal);
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    if (!localStorage.getItem("appuntiAI")) {
      document.getElementById("docDate").value = new Date().toLocaleDateString();
    }
    loadLocal();
    if (!document.getElementById("docDate").value) {
      document.getElementById("docDate").value = new Date().toLocaleDateString();
    }
  });

  // ---- AZIONI ----
  document.getElementById("copyBtn").onclick = () => {
    const output = `${document.getElementById("docTitle").value}\n${document.getElementById("docDate").value}\n${document.getElementById("docRef").value}\n\n${document.getElementById("notes").value}\n\n${document.getElementById("extra").value}`;
    navigator.clipboard.writeText(output)
      .then(() => {
        showToast("Testo copiato negli appunti");
      });
  };

  document.getElementById("clearBtn").onclick = () => {
    document.getElementById("docTitle").value = "";
    document.getElementById("docDate").value = new Date().toLocaleDateString();
    document.getElementById("docRef").value = "";
    document.getElementById("notes").value = "";
    document.getElementById("extra").value = "";
    filesState = [];
    renderFileList();
    localStorage.removeItem('appuntiAI');
    showToast("Dati resettati!");
  };

  document.getElementById("pdfBtn").onclick = () => {
    const titolo = document.getElementById("docTitle").value;
    const data = document.getElementById("docDate").value;
    const ref = document.getElementById("docRef").value;
    const corpo = document.getElementById("notes").value;
    const extra = document.getElementById("extra").value;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });

    doc.setFontSize(18);
    doc.text(titolo, 20, 22);
    doc.setFontSize(12);
    doc.text(`Data: ${data}`, 150, 22);
    doc.setDrawColor(180,180,180);
    doc.line(20, 26, 190, 26);

    doc.setFontSize(13);
    let y = 34;
    if (ref.trim()) {
      doc.text(`Documento di riferimento: ${ref}`, 20, y);
      y += 8;
    }
    doc.setFontSize(13);
    doc.text("Appunti:", 20, y); y += 7;
    const noteLines = doc.splitTextToSize(corpo, 160);
    noteLines.forEach(line => { doc.text(line, 20, y); y += 7; });
    if (extra.trim()) {
      y += 6;
      doc.setFontSize(12);
      doc.text("Note aggiuntive:", 20, y); y += 7;
      const extraLines = doc.splitTextToSize(extra, 160);
      extraLines.forEach(line => { doc.text(line, 20, y); y += 7; });
    }
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text(`¬© Appunti-AI ¬∑ www.appunti-ai.com ¬∑ ${new Date().getFullYear()}`, 20, 287);

    doc.save(`AppuntiAI-${new Date().toISOString().slice(0,10)}.pdf`);
    showToast("PDF generato!");
  };

  // ---- BACKUP/IMPORT ----
  document.getElementById("backupBtn").onclick = () => {
    const savedata = localStorage.getItem("appuntiAI") || "{}";
    const blob = new Blob([savedata], {type:"application/json"});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `AppuntiAI_backup_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast("Backup salvato");
  };
  document.getElementById("importBtn").onclick = () => {
    document.getElementById("importBackup").click();
  };
  document.getElementById("importBackup").onchange = function(ev) {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const obj = JSON.parse(e.target.result);
        localStorage.setItem("appuntiAI", JSON.stringify(obj));
        loadLocal();
        showToast("Backup importato!");
      } catch {
        alert("Il file di backup non √® valido!");
      }
    };
    reader.readAsText(file, "utf-8");
    this.value = "";
  };
</script>
</body>
</html>
