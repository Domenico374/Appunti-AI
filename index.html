<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Appunti-AI Professionale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html,body{min-height:100%;}
    body{font-family: 'Inter', Arial, sans-serif; background:#fafafa; color:#232336; max-width:780px; margin:2.2rem auto; padding:0 2vw;}
    h1{margin-bottom:36px;font-size:2.2em;}
    .custom-controls{display:flex;gap:1em;align-items:center;margin-bottom:20px;flex-wrap:wrap;}
    .docs-bar{display:flex;gap:0.5em;flex-wrap:wrap;margin-bottom:15px;}
    .docs-bar input,.search-bar input{border:1px solid #ccc;padding:7px 12px;border-radius:7px;font-size:1em;}
    .docs-bar button,.search-bar button{padding:7px 19px;border-radius:8px;border:none;background:#6366f1;color:#fff;font-weight:600;cursor:pointer;font-size:1em;margin-left:3px;}
    .docs-bar button.active{background:#3730a3;}
    .docs-bar select{padding:6px 9px;border-radius:6px;}
    .search-bar{display:flex;align-items:center;gap:10px;margin-bottom:22px;}
    .search-bar input{flex:1;}
    .highlight{background:yellow;color: #222;}
    .section{margin: 16px 0;}
    .label{color:#374151;font-weight:bold;font-size:15px;margin-top:16px;margin-bottom:7px;display:block;}
    input[type="text"], textarea, select {width: 100%; padding: 11px 13px; font-size: 1em; border-radius: 8px; border: 1px solid #d1d5db; margin-top: 4px; margin-bottom: 0.5em; background: #fff; transition: box-shadow 0.2s, border 0.2s; box-sizing: border-box;}
    input[type="text"]:focus, textarea:focus{outline:none;box-shadow:0 0 0 2px #a5b4fc88;border-color:#6366f1;}
    .actions{margin: 30px 0;display: flex;gap: 1em;flex-wrap: wrap;}
    button{padding:10px 22px; border-radius:8px; border:none; background:#6366f1; color:#fff; font-weight:600; font-size:1em;box-shadow:0 2px 12px 0 #6366f120; cursor:pointer;}
    button:hover{background:#4f46e5;}
    .footer{text-align:right;font-size:12px;color:#a2a2aa;margin-top:1.8em;}
    .file-list{margin:.5em 0 0.7em 0;padding-left:0;list-style:none;}
    .file-item{display:flex;align-items:center;background:#f4f4fd;border-radius:6px;padding:7px 8px;margin-bottom:6px;font-size:14px;}
    .file-name{flex: 1; white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    @media (max-width: 650px){body{max-width:100vw;margin:0.5rem;} .custom-controls,.actions{flex-direction:column;align-items:flex-start;gap:0.8em;}button{width:100%;}}
    .file-remove-btn{margin-left:6px;padding:3px 10px;background:#fbbf24;color:#232; font-weight:700;font-size:1em;}
    .file-remove-btn:hover{background:#fde68a;}
  </style>
</head>
<body>
  <h1>Appunti-AI Professionale</h1>
  <div class="custom-controls">
    <div class="docs-bar" id="docsBar">
      <select id="docsSelect"></select>
      <input type="text" id="newDocTitle" placeholder="Nuovo titolo documento" style="min-width:140px;">
      <button id="addDocBtn">Nuovo</button>
      <button id="removeDocBtn" style="background:#ffd6d6; color:#400;">Elimina</button>
    </div>
    <div class="search-bar">
      <input id="searchInput" placeholder="Cerca in tutti i documenti (Ctrl+F)">
      <button id="clearSearchBtn" title="Cancella ricerca">‚úñ</button>
    </div>
  </div>
  <form id="docForm" autocomplete="off" spellcheck="false">
    <div class="section">
      <span class="label">Titolo documento</span>
      <input type="text" id="docTitle">
    </div>
    <div class="section">
      <span class="label">Data</span>
      <input type="text" id="docDate">
    </div>
    <div class="section">
      <span class="label">File di riferimento</span>
      <input type="text" id="docRef">
    </div>
    <div class="section">
      <span class="label">Appunti / Corpo</span>
      <input id="fileInput" type="file" multiple accept=".txt,.pdf,.doc,.docx,.md,.mp3,.wav,.m4a" />
      <ul id="fileList" class="file-list"></ul>
      <textarea id="notes" rows="8" placeholder="Qui inserisci o carica gli appunti..."></textarea>
    </div>
    <div class="section">
      <span class="label">Note aggiuntive</span>
      <textarea id="extra" rows="3" placeholder="Note extra, dettagli, firma..."></textarea>
    </div>
    <div class="actions">
      <button type="button" id="pdfBtn">Esporta PDF</button>
      <button type="button" id="txtBtn">Esporta TXT</button>
      <button type="button" id="mdBtn">Esporta Markdown</button>
      <button type="button" id="copyBtn">Copia testo</button>
      <button type="button" id="clearBtn">Pulisci tutto</button>
    </div>
  </form>
  <hr>
  <div class="footer">¬© Appunti-AI ¬∑ www.appunti-ai.com</div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
  // ============================
  // Multi-documento
  // ============================
  let docs = JSON.parse(localStorage.getItem('aai_docs')||"[]");
  let current = 0;

  const FIELDS = ["docTitle","docDate","docRef","notes","extra"];
  function makeEmptyDoc(title){return {title,docTitle:'',docDate:new Date().toLocaleDateString(),docRef:'',notes:'',extra:'', files:[]};}

  function renderDocsSelect(){
    const select = document.getElementById("docsSelect");
    select.innerHTML = "";
    docs.forEach((doc,i)=>{
      const opt = document.createElement('option');
      opt.textContent = doc.title || "Documento "+(i+1);
      opt.value = i;
      select.appendChild(opt);
    });
    select.value = current;
  }

  function saveDocs(){
    localStorage.setItem("aai_docs",JSON.stringify(docs));
  }

  function loadDoc(idx){
    if (!docs[idx]) return;
    current = idx;
    FIELDS.forEach(f=>document.getElementById(f).value = docs[current][f]);
    renderFileList();
    renderDocsSelect();
  }

  function writeCurrentDoc(){
    FIELDS.forEach(f=>docs[current][f]=document.getElementById(f).value);
    docs[current].files = filesState;
    saveDocs();
  }

  document.getElementById("addDocBtn").onclick = ()=>{
    const title = document.getElementById("newDocTitle").value.trim()||"Documento "+(docs.length+1);
    docs.push(makeEmptyDoc(title));
    current = docs.length-1;
    saveDocs();
    renderDocsSelect(); loadDoc(current);
    document.getElementById("newDocTitle").value = "";
  };

  document.getElementById("removeDocBtn").onclick = ()=>{
    if (docs.length>1){
      docs.splice(current,1);
      current = Math.max(0,current-1);
      saveDocs();
      renderDocsSelect(); loadDoc(current);
    }else{alert("Almeno 1 documento deve restare.");}
  };

  document.getElementById("docsSelect").addEventListener("change",(e)=>{
    writeCurrentDoc();
    loadDoc(+e.target.value);
  });

  // ============================
  // File allegati singolo doc
  // ============================
  let filesState  = [];
  function renderFileList(){
    filesState = docs[current]?.files||[];
    document.getElementById("fileList").innerHTML = "";
    filesState.forEach((file,idx)=>{
      const li = document.createElement("li");
      li.className="file-item";
      const exts = file.name.split(".").pop().toUpperCase();
      const typeIcon = file.type?.startsWith("audio/")?"üé§":file.type==="application/pdf"?"üìÑ":exts==="DOCX"?"üìù":"üìÑ";
      const preview = file.preview?`<div class="file-name" style="font-size:12px;color:#469">[${file.preview}]</div>`:"";
      li.innerHTML = `<span class="file-name">${typeIcon} ${file.name} <span style="color:#aaa;">(${(file.size/1024).toFixed(1)} KB)</span>${preview}</span>
        <button class="file-remove-btn" title="Rimuovi" onclick="removeFile(${idx})">üóëÔ∏è</button>
        <button class="file-remove-btn" title="Estrai testo" onclick="extractText(${idx})" style="background:#22c55e;">‚¨áÔ∏è</button>`;
      document.getElementById("fileList").appendChild(li);
    });
    writeCurrentDoc();
  }
  window.removeFile = idx => {
    filesState.splice(idx,1);
    docs[current].files = filesState;
    renderFileList();
  }
  document.getElementById("fileInput").addEventListener("change", async (e)=>{
    let added = 0;
    const files = Array.from(e.target.files||[]);
    for (const file of files) {
      let data = null, preview = "";
      if (file.size < 2*1024*1024) {
        data = await new Promise(res => { let r = new FileReader(); r.onload = ee=>res(ee.target.result); r.readAsDataURL(file); });
        if (file.type.startsWith("text") || file.name.endsWith(".md")){
          preview = await new Promise(res => { let r = new FileReader(); r.onload = ee=>res(ee.target.result.slice(0,80)); r.readAsText(file); });
        }
      }
      filesState.push({ name:file.name, size:file.size, type:file.type, data, preview });
      added++;
    }
    docs[current].files = filesState;
    renderFileList();
    e.target.value = "";
  });
  // ============================
  // Estrazione testo file (mock)
  // ============================
  window.extractText = (idx)=>{
    const file = filesState[idx];
    if (file.data && (file.type?.startsWith("text") || file.name.endsWith(".md"))){
      const blob = b64toBlob(file.data,file.type||'text/plain'), reader = new FileReader();
      reader.onload = function(e){document.getElementById("notes").value = e.target.result;};
      reader.readAsText(blob,"UTF-8");
    } else { alert("Demo: solo anteprima txt+md oppure integra estrazione pdf/docx."); }
  }
  function b64toBlob(dataURI, mime) {
    var byteString = atob(dataURI.split(',')[1]), ab = new ArrayBuffer(byteString.length), ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
    return new Blob([ab], {type: mime});
  }
  // ============================
  // Salvataggio automatico
  // ============================
  FIELDS.forEach(id=>{
    document.getElementById(id).addEventListener("input",()=>{
      docs[current][id]=document.getElementById(id).value;
      writeCurrentDoc();
    });
  });
  // ============================
  // Inizializzazione documenti e lista
  // ============================
  if(!docs.length){docs.push(makeEmptyDoc("Documento 1"));}
  renderDocsSelect();
  loadDoc(current);

  // ============================
  // Barra ricerca live
  // ============================
  function highlight(str,query){
    if (!query) return str;
    return str.replace(new RegExp(query,"gi"),match=>`<span class="highlight">${match}</span>`);
  }
  function filterDocs(query){
    return docs.map((doc,i) => {
      let found=false, note=doc.notes||"", extra=doc.extra||"", tit=doc.title||"", fileNames=(doc.files||[]).map(f=>f.name).join(" ");
      [tit,note,extra,fileNames].forEach(txt=>{if(query && txt && txt.toLowerCase().includes(query.toLowerCase())) found=true;});
      return found ? { i, doc } : null;
    }).filter(Boolean);
  }
  document.getElementById("searchInput").addEventListener("input",function(){
    const q = this.value.trim();
    if (!q){ renderDocsSelect(); return;}
    const matches = filterDocs(q);
    const select = document.getElementById("docsSelect");
    select.innerHTML = "";
    matches.forEach(({i,doc})=>{
      const opt=document.createElement('option');
      opt.textContent = highlight(doc.title,q).replace(/<[^>]+>/g,'');
      opt.value = i;
      select.appendChild(opt);
    });
    if (matches.length){ select.value = matches[0].i; loadDoc(matches[0].i); }
  });
  document.getElementById("clearSearchBtn").onclick = ()=>{document.getElementById("searchInput").value="";renderDocsSelect();};

  // ============================
  // Esportazione TXT/MD/PDF
  // ============================
  function docAsText(d){
    return (d.docTitle||"")+"\n"+(d.docDate||"")+"\n"+(d.docRef||"")+"\n\n"+(d.notes||"")+"\n\n"+(d.extra||"");
  }
  function docAsMarkdown(d){
    return `# ${d.docTitle||""}\n\n**Data**: ${d.docDate||""}  \n**Documento di riferimento**: ${d.docRef||""}\n\n## Appunti\n${d.notes||""}\n\n---\n### Note aggiuntive\n${d.extra||""}`;
  }
  function saveFile(blob,fn){
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob); link.download=fn; document.body.appendChild(link);
    link.click(); document.body.removeChild(link);
  }
  document.getElementById("txtBtn").onclick = ()=>{ saveFile(new Blob([docAsText(docs[current])],{type:"text/plain"}), (docs[current].title||"documento")+".txt"); };
  document.getElementById("mdBtn").onclick = ()=>{ saveFile(new Blob([docAsMarkdown(docs[current])],{type:"text/markdown"}), (docs[current].title||"documento")+".md"); };
  document.getElementById("pdfBtn").onclick = ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });
    doc.setFontSize(18);
    doc.text(docs[current].docTitle||"", 20, 22);
    doc.setFontSize(12);
    doc.text(`Data: ${docs[current].docDate||""}`, 150, 22);
    doc.setDrawColor(180,180,180);
    doc.line(20, 26, 190, 26);
    doc.setFontSize(13);
    let y = 34;
    if ((docs[current].docRef||"").trim()) {
      doc.text(`Documento di riferimento: ${docs[current].docRef}`, 20, y); y += 8;
    }
    doc.setFontSize(13);
    doc.text("Appunti:", 20, y); y += 7;
    const noteLines = doc.splitTextToSize(docs[current].notes||"", 160);
    noteLines.forEach(line => { doc.text(line, 20, y); y += 7; });
    if ((docs[current].extra||"").trim()) {
      y += 6;
      doc.setFontSize(12);
      doc.text("Note aggiuntive:", 20, y); y += 7;
      const extraLines = doc.splitTextToSize(docs[current].extra||"", 160);
      extraLines.forEach(line => { doc.text(line, 20, y); y += 7; });
    }
    doc.setFontSize(11); doc.setTextColor(100);
    doc.text(`¬© Appunti-AI ¬∑ www.appunti-ai.com ¬∑ ${new Date().getFullYear()}`, 20, 287);
    doc.save(`${docs[current].title||'Appunti'}-${new Date().toISOString().slice(0,10)}.pdf`);
  };

  // ============================
  // ACCESSIBILIT√Ä: SHORCUT
  // ============================
  window.addEventListener("keydown", function(e){
      if((e.ctrlKey || e.metaKey) && document.activeElement.tagName!=="TEXTAREA"){
        if(e.key.toLowerCase()==='s'){e.preventDefault();writeCurrentDoc();saveDocs();alert('Documento Salvato!');}
        if(e.key.toLowerCase()==='f'){e.preventDefault(); document.getElementById('searchInput').focus();}
        if(e.key.toLowerCase()==='e'){e.preventDefault(); document.getElementById('txtBtn').click();}
        if(e.key.toLowerCase()==='m'){e.preventDefault(); document.getElementById('mdBtn').click();}
      }
  });
  </script>
</body>
</html>
