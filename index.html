<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Appunti-AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; color: #222; padding: 2rem; max-width: 700px; margin: auto; }
    h1 { margin-bottom: 0.5rem; color: #444; }
    label { font-weight: bold; margin-top: 1rem; display: block; }
    input[type="file"] { margin-bottom: 1rem; }
    textarea { width: 100%; min-height: 180px; margin-top: 1rem; }
    .actions { margin: 1em 0; display: flex; gap: 1em; }
    button { background: #e8e8e8; border: 1px solid #ccc; padding: 6px 18px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #e0e7ff; border-color: #555; }
  </style>
  <!-- PDF.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Mammoth.js per DOCX -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <!-- jsPDF per esportazione PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Appunti-AI</h1>
  <label for="fileInput">Carica file (TXT, PDF, DOCX, audio):</label>
  <input
    id="fileInput"
    type="file"
    multiple
    accept=".txt,.pdf,.doc,.docx,.md,.mp3,.wav,.m4a"
  />

  <h2>Appunti</h2>
  <div class="actions">
    <button id="copyBtn">Copia appunti</button>
    <button id="pdfBtn">Esporta PDF</button>
  </div>
  <textarea id="notes" placeholder="Qui appariranno gli appunti estratti o trascritti..."></textarea>

  <script>
    const fileInput = document.getElementById("fileInput");
    const notesBox = document.getElementById("notes");
    const copyBtn = document.getElementById("copyBtn");
    const pdfBtn = document.getElementById("pdfBtn");

    fileInput?.addEventListener("change", (e) => {
      const files = Array.from(e.target.files || []);
      for (const file of files) {
        if (file.type.startsWith("audio/")) {
          trascriviAudioOpenAI(file);
          return;
        }
        if (file.type === "application/pdf") {
          estraiTestoPDF(file);
          return;
        }
        if (file.name.endsWith(".docx")) {
          estraiTestoDOCX(file);
          return;
        }
        leggiTesto(file); // Solo per TXT/MD
      }
    });

    function leggiTesto(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const extracted = e.target.result;
        localStorage.setItem("appunti_ai_extractedText", extracted);
        notesBox.value = extracted;
      };
      reader.readAsText(file, "UTF-8");
    }

    function estraiTestoPDF(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const typedarray = new Uint8Array(e.target.result);
        pdfjsLib.getDocument(typedarray).promise.then(pdf => {
          let testoTotale = "";
          let promesse = [];
          for (let i = 1; i <= pdf.numPages; i++) {
            promesse.push(pdf.getPage(i).then(page =>
              page.getTextContent().then(txt => {
                testoTotale += txt.items.map(item => item.str).join(" ") + "\n";
              })
            ));
          }
          Promise.all(promesse).then(() => {
            notesBox.value = testoTotale;
            localStorage.setItem("appunti_ai_extractedText", testoTotale);
          });
        });
      };
      reader.readAsArrayBuffer(file);
    }

    function estraiTestoDOCX(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        mammoth.convertToHtml({ arrayBuffer: e.target.result })
          .then(result => {
            const html = result.value;
            const txt = html.replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ').trim();
            notesBox.value = txt;
            localStorage.setItem("appunti_ai_extractedText", txt);
          })
          .catch(() => alert("Errore estrazione DOCX."));
      };
      reader.readAsArrayBuffer(file);
    }

    function trascriviAudioOpenAI(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const audioBase64 = e.target.result.split(',')[1];
        fetch("/api/trascrivi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            audioBase64,
            audioMimeType: file.type
          })
        })
        .then(r => r.json())
        .then(data => {
          if (data.testo) {
            localStorage.setItem("appunti_ai_extractedText", data.testo);
            notesBox.value = data.testo;
            alert("Trascrizione audio completata!");
          } else {
            alert("Errore trascrizione audio.");
          }
        })
        .catch(() => alert("Errore nella richiesta di trascrizione audio."));
      };
      reader.readAsDataURL(file);
    }

    // Copia appunti
    copyBtn.addEventListener("click", () => {
      if (!notesBox.value.trim()) return;
      navigator.clipboard.writeText(notesBox.value)
        .then(() => {
          copyBtn.textContent = "✓ Copiato!";
          setTimeout(() => copyBtn.textContent = "Copia appunti", 1500);
        });
    });

    // Esporta PDF
    pdfBtn.addEventListener("click", () => {
      if (!notesBox.value.trim()) return;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const margin = 15, width = 180;
      const lines = doc.splitTextToSize(notesBox.value, width);
      doc.text(lines, margin, 30);
      doc.save(`AppuntiAI-${new Date().toISOString().slice(0,10)}.pdf`);
      pdfBtn.textContent = "✓ Salvato!";
      setTimeout(() => pdfBtn.textContent = "Esporta PDF", 1500);
    });

    // Ripristino automatico
    const estrattiSalvati = localStorage.getItem("appunti_ai_extractedText");
    if (estrattiSalvati) notesBox.value = estrattiSalvati;
  </script>
</body>
</html>
