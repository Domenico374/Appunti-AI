<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Appunti-AI Professionale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style id="maincss">
    html{min-height:100%;}
    body{font-family:var(--font, Inter),Arial,sans-serif;background:var(--bg,#fafafa);color:var(--fg,#222);max-width:780px;margin:2.5rem auto;padding:0 2vw;transition:background .2s,color .2s;font-size:var(--fontsize,1em);}
    h1{margin-bottom:36px;font-size:2.2em;}
    .custom-controls{display:flex;gap:1.2em;align-items:center;margin-bottom:18px;flex-wrap:wrap;}
    .docs-bar{display:flex;gap:0.5em;flex-wrap:wrap;}
    .docs-bar input,.search-bar input{border:1px solid #ccc;padding:7px 12px;border-radius:7px;font-size:1em;}
    .docs-bar button,.search-bar button{padding:7px 19px;border-radius:8px;border:none;background:#6366f1;color:#fff;font-weight:600;cursor:pointer;font-size:1em;margin-left:3px;}
    .docs-bar button.active{background:#3730a3;}
    .docs-bar select{padding:6px 9px;border-radius:6px;}
    .custom-controls label{font-size:.95em;color:#444;}
    .search-bar{display:flex;align-items:center;gap:10px;margin-bottom:22px;}
    .search-bar input{flex:1;}
    .highlight{background:yellow;color:#222;}
    .section{margin: 16px 0;}
    .label{color:#374151;font-weight:bold;font-size:15px;margin-top:16px;margin-bottom:7px;display:block;}
    input[type="text"], textarea, select {width: 100%; padding: 11px 13px; font-size: 1em; border-radius: 8px; border: 1px solid #d1d5db; margin-top: 4px; margin-bottom: 0.5em; background: var(--input-bg, #fff); color: var(--input-fg, inherit);}
    input[type="text"]:focus, textarea:focus{outline:none;box-shadow:0 0 0 2px #a5b4fc88;border-color:#6366f1;}
    input[type="file"]{margin-bottom:.7em;}
    .version-list{margin:.8em 0;padding:0;border:1px solid #dadada;border-radius:7px;background:#fafafb;list-style:none;max-height:180px;overflow-y:auto;font-size:13px;}
    .version-list li{border-bottom:1px solid #eee;padding:7px 14px;display:flex;justify-content:space-between;align-items:center;}
    .version-list li:last-child{border-bottom:none;}
    .version-btn{background:#2780e3;padding:6px 13px;border-radius:7px;font-size:1em;font-weight:600;margin-left:5px;color:#fff;}
    .version-btn:hover{background:#0560ba;}
    .actions{margin: 30px 0;display: flex;gap: 1em;flex-wrap: wrap;}
    button{padding:10px 22px; border-radius:8px; border:none; background:#6366f1; color:#fff; font-weight:600; font-size:1em;box-shadow:0 2px 12px 0 #6366f120; cursor:pointer;}
    button:hover{background:#4f46e5;}
    .footer{text-align:right;font-size:12px;color:#aaa;margin-top:1.6em;}
    .file-list{margin:.5em 0 0.7em 0;padding-left:0;list-style:none;}
    .file-item{display:flex;align-items:center;background:#f4f4fd;border-radius:6px;padding:7px 8px;margin-bottom:6px;font-size:14px;}
    .file-name{flex: 1; white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .file-remove-btn{margin-left:6px;padding:3px 10px;background:#fbbf24;color:#232;font-weight:700;font-size:1em;}
    .file-remove-btn:hover{background:#fde68a;}
    .toast {position:fixed;bottom:32px;left:50%;transform:translateX(-50%);min-width:160px;background:#3730a3;color:#fff;padding:13px 30px;border-radius:8px;font-size:1em;box-shadow:0 2px 14px 0 #6366f145;opacity:0;transition:opacity 0.3s;z-index:9999;pointer-events:none;}
    .toast.active { opacity:1; pointer-events:auto;}
    .spinner-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;}
    .lds-dual-ring{display:inline-block;width:64px;height:64px;}
    .lds-dual-ring:after{content:" ";display:block;width:46px;height:46px;margin:8px;border-radius:50%;border:6px solid #6366f1;border-color:#6366f1 transparent #6366f1 transparent;animation:lds-dual-ring 1.1s linear infinite;}
    @keyframes lds-dual-ring{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    body.dark{--bg:#171923;--fg:#fafafa;--input-bg:#23263b;--input-fg:#fff;}
    body.dark .section{border-color:#343449;}
    body.dark .file-item{background:#282a3d;}
    body.dark .footer,.file-info{color:#bbb;}
    .compact .section{margin-top:10px;margin-bottom:10px;}
    @media (max-width: 650px){
      body{max-width:100vw;margin:0.5rem;}
      h1{font-size: 1.3em;margin-top: 22px;margin-bottom: 14px;}
      .custom-controls,.actions{flex-direction:column;align-items:flex-start;gap:0.8em;}
      button{width:100%;}
    }
  </style>
</head>
<body>
  <div class="custom-controls">
    <button id="themeToggle" title="Tema Chiaro/Scuro">üåì Tema</button>
    <label>Font
      <select id="fontChoice">
        <option value="Inter">Inter</option>
        <option value="Arial">Arial</option>
        <option value="Roboto">Roboto</option>
        <option value="Georgia">Georgia</option>
        <option value="monospace">Monospace</option>
      </select>
    </label>
    <label>Testo
      <select id="fontSizeChoice">
        <option value="1em">Normale</option>
        <option value="1.18em">Grande</option>
        <option value="0.90em">Compatto</option>
      </select>
    </label>
    <label><input type="checkbox" id="compactToggle"> Compatta spazi</label>
    <div class="docs-bar" id="docsBar">
      <select id="docsSelect"></select>
      <input type="text" id="newDocTitle" placeholder="Nuovo titolo documento" style="min-width:140px;">
      <button id="addDocBtn">Nuovo</button>
      <button id="removeDocBtn" style="background:#ffd6d6; color:#400;">Elimina</button>
    </div>
    <div class="search-bar">
      <input id="searchInput" placeholder="Cerca in tutti i documenti (Ctrl+F)">
      <button id="clearSearchBtn" title="Cancella ricerca">‚úñ</button>
    </div>
  </div>
  <h1>Appunti-AI Professionale</h1>
  <form id="docForm" autocomplete="off" spellcheck="false">
    <div class="section">
      <span class="label">Titolo documento</span>
      <input type="text" id="docTitle">
    </div>
    <div class="section">
      <span class="label">Data</span>
      <input type="text" id="docDate">
    </div>
    <div class="section">
      <span class="label">File di riferimento</span>
      <input type="text" id="docRef">
    </div>
    <div class="section">
      <span class="label">Appunti / Corpo</span>
      <input id="fileInput" type="file" multiple accept=".txt,.pdf,.doc,.docx,.md,.mp3,.wav,.m4a" />
      <ul id="fileList" class="file-list"></ul>
      <textarea id="notes" rows="8" placeholder="Qui inserisci o carica gli appunti..."></textarea>
    </div>
    <div class="section">
      <span class="label">Note aggiuntive</span>
      <textarea id="extra" rows="3" placeholder="Note extra, dettagli, firma..."></textarea>
    </div>
    <div class="actions">
      <button type="button" id="pdfBtn">Esporta PDF</button>
      <button type="button" id="txtBtn">Esporta TXT</button>
      <button type="button" id="mdBtn">Esporta Markdown</button>
      <button type="button" id="copyBtn">Copia testo</button>
      <button type="button" id="clearBtn">Pulisci tutto</button>
    </div>
    <div class="section" style="margin-top:20px;">
      <b>Cronologia Backup versioni</b>
      <ul id="versionList" class="version-list"></ul>
    </div>
  </form>
  <hr>
  <div class="footer">¬© Appunti-AI ¬∑ www.appunti-ai.com</div>
  <div id="spinner" class="spinner-overlay" style="display:none;">
    <div class="lds-dual-ring"></div>
  </div>
  <div id="toast" class="toast"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  // ==========  THEMES & PREFERENCES ==========
  function applyTheme(theme) {
    document.body.classList.toggle("dark", theme === "dark");
    localStorage.setItem("aai_theme", theme);
  }
  function getInitialTheme() {
    const t = localStorage.getItem("aai_theme");
    if (t) return t;
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  }
  document.addEventListener("DOMContentLoaded", () => {
    applyTheme(getInitialTheme());
    document.getElementById("themeToggle").onclick = () => {
      const newTheme = document.body.classList.contains("dark") ? "light" : "dark";
      applyTheme(newTheme);
    };
    // Personalizzazione font/dimensione
    const fontChoice = document.getElementById("fontChoice");
    const fontSizeChoice = document.getElementById("fontSizeChoice");
    const compactToggle = document.getElementById("compactToggle");
    function applyCustom() {
      document.body.style.setProperty('--font', fontChoice.value);
      document.body.style.setProperty('--fontsize', fontSizeChoice.value);
      document.body.classList.toggle("compact", compactToggle.checked);
      localStorage.setItem("aai_font", fontChoice.value);
      localStorage.setItem("aai_fontsize", fontSizeChoice.value);
      localStorage.setItem("aai_compact", compactToggle.checked?"1":"");
    }
    fontChoice.value = localStorage.getItem("aai_font") || "Inter";
    fontSizeChoice.value = localStorage.getItem("aai_fontsize") || "1em";
    compactToggle.checked = !!localStorage.getItem("aai_compact");
    fontChoice.onchange = applyCustom;
    fontSizeChoice.onchange = applyCustom;
    compactToggle.onchange = applyCustom;
    applyCustom();
  });
  // ========== TOAST ==========
  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 1700);
  }
  // ========== SPINNER ==========
  function showSpinner() { document.getElementById("spinner").style.display = "flex"; }
  function hideSpinner() { document.getElementById("spinner").style.display = "none"; }
  // ========== MULTI-DOCUMENTO + VERSIONING ==========
  let docs = JSON.parse(localStorage.getItem('aai_docs')||"[]");
  let current = 0;
  const FIELDS = ["docTitle","docDate","docRef","notes","extra"];
  function makeEmptyDoc(title){return {title,docTitle:'',docDate:new Date().toLocaleDateString(),docRef:'',notes:'',extra:'', files:[], _versions:[]};}
  function renderDocsSelect(){
    const select = document.getElementById("docsSelect");
    select.innerHTML = "";
    docs.forEach((doc,i)=>{
      const opt = document.createElement('option');
      opt.textContent = doc.title || "Documento "+(i+1);
      opt.value = i;
      select.appendChild(opt);
    });
    select.value = current;
  }
  function saveDocs(){
    localStorage.setItem("aai_docs",JSON.stringify(docs, null, 2));
  }
  function saveVersion(){
    let v = {...docs[current]};
    delete v._versions;
    docs[current]._versions = docs[current]._versions || [];
    docs[current]._versions.unshift({ts: new Date().toLocaleString(), data: v});
    if (docs[current]._versions.length>10) docs[current]._versions = docs[current]._versions.slice(0,10);
    renderVersions();
    saveDocs();
  }
  function renderVersions(){
    const list = document.getElementById("versionList");
    const arr = (docs[current]._versions)||[];
    list.innerHTML = arr.length ? "" : "<li>Nessun backup ancora.</li>";
    arr.forEach((v,i)=>{
      const li=document.createElement("li");
      li.innerHTML=`<span>${v.ts}</span>
      <button class="version-btn" onclick="restoreVersion(${i})">Ripristina</button>`;
      list.appendChild(li);
    });
  }
  window.restoreVersion = function(idx){
    const ver = docs[current]._versions?.[idx];
    if(ver?.data){
      FIELDS.forEach(f=>docs[current][f]=ver.data[f]||"");
      docs[current].files = ver.data.files || [];
      writeCurrentDoc(); loadDoc(current); renderFileList();
      showToast("Versione ripristinata!");
    }
  };
  function loadDoc(idx){
    if (!docs[idx]) return;
    current = idx;
    FIELDS.forEach(f=>document.getElementById(f).value = docs[current][f]);
    renderFileList(); renderDocsSelect(); renderVersions();
  }
  function writeCurrentDoc(){
    FIELDS.forEach(f=>docs[current][f]=document.getElementById(f).value);
    docs[current].files = filesState;
    saveDocs(); saveVersion();
  }
  document.getElementById("addDocBtn").onclick = ()=>{
    const title = document.getElementById("newDocTitle").value.trim()||"Documento "+(docs.length+1);
    docs.push(makeEmptyDoc(title));
    current = docs.length-1;
    saveDocs(); renderDocsSelect(); loadDoc(current);
    document.getElementById("newDocTitle").value = "";
    showToast("Nuovo documento creato");
  };
  document.getElementById("removeDocBtn").onclick = ()=>{
    if (docs.length>1){
      docs.splice(current,1); current = Math.max(0,current-1);
      saveDocs(); renderDocsSelect(); loadDoc(current);
      showToast("Documento eliminato");
    }else{alert("Almeno 1 documento deve restare.");}
  };
  document.getElementById("docsSelect").addEventListener("change",(e)=>{
    writeCurrentDoc();loadDoc(+e.target.value);
  });
  // ========== RICERCA LIVE ==========
  function highlight(str,query){
    if (!query) return str;
    return str.replace(new RegExp(query,"gi"),match=>`<span class="highlight">${match}</span>`);
  }
  function filterDocs(query){
    return docs.map((doc,i) => {
      let found=false, note=doc.notes||"", extra=doc.extra||"", tit=doc.title||"", fileNames=(doc.files||[]).map(f=>f.name).join(" ");
      [tit,note,extra,fileNames].forEach(txt=>{if(query && txt && txt.toLowerCase().includes(query.toLowerCase())) found=true;});
      return found ? { i, doc } : null;
    }).filter(Boolean);
  }
  document.getElementById("searchInput").addEventListener("input",function(){
    const q = this.value.trim();
    if (!q){ renderDocsSelect(); return;}
    const matches = filterDocs(q);
    const select = document.getElementById("docsSelect");
    select.innerHTML = "";
    matches.forEach(({i,doc})=>{
      const opt=document.createElement('option');
      opt.textContent = highlight(doc.title,q).replace(/<[^>]+>/g,'');
      opt.value = i;
      select.appendChild(opt);
    });
    if (matches.length){ select.value = matches[0].i; loadDoc(matches[0].i);}
  });
  document.getElementById("clearSearchBtn").onclick = ()=>{document.getElementById("searchInput").value="";renderDocsSelect();};
  // ========== FILE MANAGEMENT ==========
  let filesState = [];
  function renderFileList(){
    filesState = docs[current]?.files||[];
    document.getElementById("fileList").innerHTML = "";
    filesState.forEach((file,idx)=>{
      const li = document.createElement("li");
      li.className="file-item";
      const exts = file.name.split(".").pop().toUpperCase();
      const typeIcon = file.type?.startsWith("audio/")?"üé§":file.type==="application/pdf"?"üìÑ":exts==="DOCX"?"üìù":"üìÑ";
      const preview = file.preview?`<div class="file-name" style="font-size:12px;color:#469">[${file.preview}]</div>`:"";
      li.innerHTML = `<span class="file-name">${typeIcon} ${file.name} <span style="color:#aaa;">(${(file.size/1024).toFixed(1)} KB)</span>${preview}</span>
        <button class="file-remove-btn" title="Rimuovi" onclick="removeFile(${idx})">üóëÔ∏è</button>
        <button class="file-remove-btn" title="Estrai testo" onclick="extractText(${idx})" style="background:#22c55e;">‚¨áÔ∏è</button>`;
      document.getElementById("fileList").appendChild(li);
    });
    writeCurrentDoc();
  }
  window.removeFile = idx => {
    filesState.splice(idx,1);
    docs[current].files = filesState;
    renderFileList();
    showToast("File rimosso");
  }
  document.getElementById("fileInput").addEventListener("change", async (e)=>{
    let added = 0;
    const files = Array.from(e.target.files||[]);
    for (const file of files) {
      let data = null, preview = "";
      if (file.size < 2*1024*1024) {
        data = await new Promise(res => { let r = new FileReader(); r.onload = ee=>res(ee.target.result); r.readAsDataURL(file); });
        if (file.type.startsWith("text") || file.name.endsWith(".md")){
          preview = await new Promise(res => { let r = new FileReader(); r.onload = ee=>res(ee.target.result.slice(0,80)); r.readAsText(file); });
        }
      }
      filesState.push({ name:file.name, size:file.size, type:file.type, data, preview });
      added++;
    }
    docs[current].files = filesState;
    renderFileList();
    e.target.value = "";
    if(added) showToast(`${added} file aggiunto${added>1?'i':''}`);
  });
  // ========== ANTEPRIMA+ESTRAZIONE FILE TXT ==========
  window.extractText = (idx)=>{
    const file = filesState[idx];
    if (file.data && (file.type?.startsWith("text") || file.name.endsWith(".md"))){
      const blob = b64toBlob(file.data,file.type||'text/plain'), reader = new FileReader();
      reader.onload = function(e){document.getElementById("notes").value = e.target.result;};
      reader.readAsText(blob,"UTF-8");
      showToast("Testo caricato");
    } else { showToast("Demo: solo anteprima txt+md. Integra estrattori per pdf/docx se vuoi."); }
  }
  function b64toBlob(dataURI, mime) {
    var byteString = atob(dataURI.split(',')[1]), ab = new ArrayBuffer(byteString.length), ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
    return new Blob([ab], {type: mime});
  }
  // ========== AUTOSAVE FIELDS ==========
  FIELDS.forEach(id=>{
    document.getElementById(id).addEventListener("input",()=>{docs[current][id]=document.getElementById(id).value;writeCurrentDoc();});
  });
  // ========== INIZIALIZZAZIONE ==========
  if(!docs.length){docs.push(makeEmptyDoc("Documento 1"));}
  renderDocsSelect();loadDoc(current);
  // ========== ESPORTA TXT/MD/PDF ==========
  function docAsText(d){
    return (d.docTitle||"")+"\n"+(d.docDate||"")+"\n"+(d.docRef||"")+"\n\n"+(d.notes||"")+"\n\n"+(d.extra||"");
  }
  function docAsMarkdown(d){
    return `# ${d.docTitle||""}\n\n**Data**: ${d.docDate||""}  \n**Documento di riferimento**: ${d.docRef||""}\n\n## Appunti\n${d.notes||""}\n\n---\n### Note aggiuntive\n${d.extra||""}`;
  }
  function saveFile(blob,fn){
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob); link.download=fn; document.body.appendChild(link);
    link.click(); document.body.removeChild(link);
  }
  document.getElementById("txtBtn").onclick = ()=>{ saveFile(new Blob([docAsText(docs[current])],{type:"text/plain"}), (docs[current].title||"documento")+".txt"); showToast("TXT esportato!");};
  document.getElementById("mdBtn").onclick = ()=>{ saveFile(new Blob([docAsMarkdown(docs[current])],{type:"text/markdown"}), (docs[current].title||"documento")+".md"); showToast("MD esportato!");};
  document.getElementById("pdfBtn").onclick = ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });
    doc.setFontSize(18);
    doc.text(docs[current].docTitle||"", 20, 22);
    doc.setFontSize(12);
    doc.text(`Data: ${docs[current].docDate||""}`, 150, 22);
    doc.setDrawColor(180,180,180);
    doc.line(20, 26, 190, 26);
    doc.setFontSize(13);
    let y = 34;
    if ((docs[current].docRef||"").trim()) {
      doc.text(`Documento di riferimento: ${docs[current].docRef}`, 20, y); y += 8;
    }
    doc.setFontSize(13);
    doc.text("Appunti:", 20, y); y += 7;
    const noteLines = doc.splitTextToSize(docs[current].notes||"", 160);
    noteLines.forEach(line => { doc.text(line, 20, y); y += 7; });
    if ((docs[current].extra||"").trim()) {
      y += 6;
      doc.setFontSize(12);
      doc.text("Note aggiuntive:", 20, y); y += 7;
      const extraLines = doc.splitTextToSize(docs[current].extra||"", 160);
      extraLines.forEach(line => { doc.text(line, 20, y); y += 7; });
    }
    doc.setFontSize(11); doc.setTextColor(100);
    doc.text(`¬© Appunti-AI ¬∑ www.appunti-ai.com ¬∑ ${new Date().getFullYear()}`, 20, 287);
    doc.save(`${docs[current].title||'Appunti'}-${new Date().toISOString().slice(0,10)}.pdf`);
    showToast("PDF esportato!");
  };
  // ======= UTILITY
  document.getElementById("copyBtn").onclick = () => {
    navigator.clipboard.writeText(docAsText(docs[current]))
      .then(() => { showToast("Testo copiato negli appunti"); });
  };
  document.getElementById("clearBtn").onclick = () => {
    FIELDS.forEach(id=>document.getElementById(id).value="");
    docs[current] = makeEmptyDoc(docs[current].title);
    renderFileList();
    saveDocs();
    showToast("Dati resettati!");
  };
  // ========== HOTKEY ==========
  window.addEventListener("keydown", function(e){
    if((e.ctrlKey||e.metaKey) && document.activeElement.tagName!=="TEXTAREA"){
      if(e.key.toLowerCase()==='s'){e.preventDefault();writeCurrentDoc();showToast('Documento salvato!');}
      if(e.key.toLowerCase()==='f'){e.preventDefault(); document.getElementById('searchInput').focus();}
      if(e.key.toLowerCase()==='e'){e.preventDefault(); document.getElementById('txtBtn').click();}
      if(e.key.toLowerCase()==='m'){e.preventDefault(); document.getElementById('mdBtn').click();}
    }
  });
</script>
</body>
</html>
