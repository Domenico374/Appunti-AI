<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Appunti-AI Professionale</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 2rem auto; background: #fafafa; color: #2a2a2a; }
    h1 { font-size: 2.2em; margin-top: 36px; margin-bottom: 36px; }
    .section { margin: 26px 0 20px 0; }
    .label {
      color: #374151;
      font-weight: bold;
      font-size: 15px;
      margin-top: 16px;
      margin-bottom: 7px;
      display: block;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 11px 13px;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      margin-top: 4px;
      margin-bottom: 0.5em;
      background: #fff;
      transition: box-shadow 0.2s, border 0.2s;
      box-sizing: border-box;
    }
    input[type="text"]:focus, textarea:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 2px #a5b4fc88;
      border-color: #6366f1;
    }
    input[type="file"] {
      margin-bottom: 0.7em;
    }
    .actions {
      margin: 32px 0;
      display: flex;
      gap: 1em;
    }
    button {
      padding: 10px 22px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      background: #6366f1;
      color: #fff;
      box-shadow: 0 2px 12px 0 #6366f120;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s;
    }
    button:hover {
      background: #4f46e5;
      box-shadow: 0 3px 14px 0 #6366f149;
    }
    .footer { font-size: 12px; color: #888; text-align: right; margin-top: 2em; }
    hr { margin: 2em 0; }
    .file-info { font-size: 12px; color: #666; margin-bottom: 0.3em; }
  </style>
  <!-- PDF.js per PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Mammoth.js per DOCX -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <!-- jsPDF per esportazione PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Appunti-AI Professionale</h1>
  <div class="section">
    <span class="label">Titolo documento</span>
    <input type="text" id="docTitle" value="Verbale Riunione">
  </div>
  <div class="section">
    <span class="label">Data</span>
    <input type="text" id="docDate" value="">
  </div>
  <div class="section">
    <span class="label">File di riferimento</span>
    <input type="text" id="docRef" value="">
    <div class="file-info" id="fileInfo"></div>
  </div>
  <div class="section">
    <span class="label">Appunti / Corpo</span>
    <input id="fileInput" type="file" multiple accept=".txt,.pdf,.doc,.docx,.md,.mp3,.wav,.m4a" />
    <textarea id="notes" rows="8" placeholder="Qui inserisci o carica gli appunti..."></textarea>
  </div>
  <div class="section">
    <span class="label">Note aggiuntive</span>
    <textarea id="extra" rows="3" placeholder="Note extra, dettagli, firma..."></textarea>
  </div>
  <div class="actions">
    <button id="pdfBtn">Esporta PDF</button>
    <button id="copyBtn">Copia testo</button>
    <button id="clearBtn">Pulisci tutto</button>
  </div>
  <hr>
  <div class="footer">© Appunti-AI · www.appunti-ai.com</div>

<script>
  // Imposta data automatica
  document.getElementById("docDate").value = new Date().toLocaleDateString();
  const fileInput = document.getElementById("fileInput");
  const notesBox = document.getElementById("notes");
  const copyBtn = document.getElementById("copyBtn");
  const pdfBtn = document.getElementById("pdfBtn");
  const clearBtn = document.getElementById("clearBtn");
  const docRef = document.getElementById("docRef");
  const fileInfo = document.getElementById("fileInfo");

  fileInput?.addEventListener("change", (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length > 0) {
      fileInfo.textContent = files.map(f => `${f.name} • ${(f.size/1024).toFixed(1)} KB`).join(", ");
      docRef.value = files[0].name;
    } else {
      fileInfo.textContent = "";
      docRef.value = "";
    }
    for (const file of files) {
      if (file.type.startsWith("audio/")) {
        trascriviAudioOpenAI(file);
        return;
      }
      if (file.type === "application/pdf") {
        estraiTestoPDF(file);
        return;
      }
      if (file.name.endsWith(".docx")) {
        estraiTestoDOCX(file);
        return;
      }
      leggiTesto(file); // Solo TXT/MD
    }
  });

  function leggiTesto(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const extracted = e.target.result;
      notesBox.value = extracted;
    };
    reader.readAsText(file, "UTF-8");
  }

  function estraiTestoPDF(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const typedarray = new Uint8Array(e.target.result);
      pdfjsLib.getDocument(typedarray).promise.then(pdf => {
        let testoTotale = "";
        let promesse = [];
        for (let i = 1; i <= pdf.numPages; i++) {
          promesse.push(pdf.getPage(i).then(page =>
            page.getTextContent().then(txt => {
              testoTotale += txt.items.map(item => item.str).join(" ") + "\n";
            })
          ));
        }
        Promise.all(promesse).then(() => {
          notesBox.value = testoTotale;
        });
      });
    };
    reader.readAsArrayBuffer(file);
  }

  function estraiTestoDOCX(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      mammoth.convertToHtml({ arrayBuffer: e.target.result })
        .then(result => {
          const html = result.value;
          const txt = html.replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ').trim();
          notesBox.value = txt;
        })
        .catch(() => alert("Errore estrazione DOCX."));
    };
    reader.readAsArrayBuffer(file);
  }

  function trascriviAudioOpenAI(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const audioBase64 = e.target.result.split(',')[1];
      fetch("/api/trascrivi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          audioBase64,
          audioMimeType: file.type
        })
      })
      .then(r => r.json())
      .then(data => {
        if (data.testo) {
          notesBox.value = data.testo;
        } else {
          alert("Errore trascrizione audio.");
        }
      })
      .catch(() => alert("Errore nella richiesta di trascrizione audio."));
    };
    reader.readAsDataURL(file);
  }

  // Copia testo
  copyBtn.onclick = () => {
    const output = `${document.getElementById("docTitle").value}\n${document.getElementById("docDate").value}\n${document.getElementById("docRef").value}\n\n${notesBox.value}\n\n${document.getElementById("extra").value}`;
    navigator.clipboard.writeText(output)
      .then(() => {
        copyBtn.textContent = "✓ Copiato!";
        setTimeout(() => copyBtn.textContent = "Copia testo", 1600);
      });
  };

  // Pulisci tutto
  clearBtn.onclick = () => {
    document.getElementById("docTitle").value = "";
    document.getElementById("docDate").value = new Date().toLocaleDateString();
    document.getElementById("docRef").value = "";
    notesBox.value = "";
    document.getElementById("extra").value = "";
    fileInfo.textContent = "";
    clearBtn.textContent = "✓ Pulito!";
    setTimeout(() => clearBtn.textContent = "Pulisci tutto", 1200);
  };

  // PDF professionale
  pdfBtn.onclick = () => {
    const titolo = document.getElementById("docTitle").value;
    const data = document.getElementById("docDate").value;
    const ref = document.getElementById("docRef").value;
    const corpo = notesBox.value;
    const extra = document.getElementById("extra").value;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });

    doc.setFontSize(18);
    doc.text(titolo, 20, 22);
    doc.setFontSize(12);
    doc.text(`Data: ${data}`, 150, 22);
    doc.setDrawColor(180,180,180);
    doc.line(20, 26, 190, 26);

    doc.setFontSize(13);
    let y = 34;
    if (ref.trim()) {
      doc.text(`Documento di riferimento: ${ref}`, 20, y);
      y += 8;
    }
    doc.setFontSize(13);
    doc.text("Appunti:", 20, y); y += 7;
    const noteLines = doc.splitTextToSize(corpo, 160);
    noteLines.forEach(line => { doc.text(line, 20, y); y += 7; });
    if (extra.trim()) {
      y += 6;
      doc.setFontSize(12);
      doc.text("Note aggiuntive:", 20, y); y += 7;
      const extraLines = doc.splitTextToSize(extra, 160);
      extraLines.forEach(line => { doc.text(line, 20, y); y += 7; });
    }

    // Footer su pagina
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text(`© Appunti-AI · [www.appunti-ai.com](https://www.appunti-ai.com) · ${new Date().getFullYear()}`, 20, 287);

    doc.save(`AppuntiAI-${new Date().toISOString().slice(0,10)}.pdf`);
  };
</script>
</body>
</html>
